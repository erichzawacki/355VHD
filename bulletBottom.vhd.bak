library IEEE;

use IEEE.std_logic_1164.all;
use IEEE.numeric_std.all;
use IEEE.MATH_REAL.ALL;

entity bottom_bullet is
	port( 
	hist0 : in std_logic_vector(7 downto 0);
	hist1 : in std_logic_vector(7 downto 0);
	clk 	: in std_logic;
	rst_n : in std_logic;
	-- tank stuff goes here --
	tank_bottomx : in integer;
	--bullet stuff
	bottom_bulletx : out integer;
	bottom_bullety : out integer
	);
end entity bottom_bullet;


architecture behavioral of bottom_bullet  is

type state_type is (A, B);
signal state: state_type := A;
signal next_state: state_type := A;


signal bottom_bulletx_c : integer := 320;
signal bottom_bulletx_shot : integer := 320;
signal bottom_bullety_c : integer := 395;
signal bottom_bullet_fired_c : integer := 0;
signal bottom_bullet_fired_temp : integer := 0;
signal bullet_offsetx : integer := 10;
signal bullet_offsety : integer := 10;
signal clock_divide_bullet : integer := 250000;
signal clock_counter : integer := 0;
signal clock_counter_c : integer := 0;
begin

	bottom_bulletClocked : process(clk, rst_n) is
	
	begin
		if (rst_n = 0) then 
			bottom_bulletx <= 320;
			bottom_bullety <= 395;
		else if (rising_edge(clk)) then
			state <= next_state;
			bottom_bulletx <= bottom_bulletx_c;
			bottom_bullety <= bottom_bullety_c;
			clock_counter <= clock_counter_c;
			bottom_bulletx_shot <= bottom_bulletx_c;
		
	end process bottom_bulletClocked;


	bulletFire : process( bottom_bullety_c, hist0 ) 
	begin
		case( state ) is 
			when A =>  
				bottom_bulletx_c <= tank_bottomx;
				bottom_bullety_c <= 395;
				clock_counter_c <= clock_counter_c + 1;
				if ((hist1 = x"1D") and (hist0 = x"F0")) then
					next_state <= B;
				end if;
			when B =>
				bottom_bulletx_c <= bottom_bulletx_shot;
				if (clock_counter mod clock_divide_bullet = 0) then
					bottom_bullety_c <= bottom_bullety_c - 1;
				end if;
				clock_counter_c <= clock_counter_c + 1;
				if (bottom_bullety_c-bullet_offsety <= 0) then
					next_state <= A;
				end if;
			when others => null;
			
		end case ;
		
	end process ; 

end architecture behavioral;	